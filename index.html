<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物品借用管理系统</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Helvetica Neue', Helvetica, sans-serif; background: #f5f7fa; }
        .header { background: white; padding: 0 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-content { display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .header h1 { color: #409EFF; }
        .container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .search-header { display: flex; margin-bottom: 20px; gap: 16px; align-items: center; }
        .low-stock { color: #f56c6c; font-weight: bold; }
        .item-info { background: #f5f7fa; padding: 16px; border-radius: 4px; margin-bottom: 16px; }
    </style>
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="header-content">
                <h1>物品借用管理系统</h1>
                <el-menu mode="horizontal" :default-active="activeMenu" @select="handleMenuSelect">
                    <el-menu-item index="items">物品列表</el-menu-item>
                    <el-menu-item index="return">物品归还</el-menu-item>
                    <el-menu-item index="admin">管理后台</el-menu-item>
                </el-menu>
            </div>
        </header>

        <main class="container">
            <!-- 物品列表页面 -->
            <div v-if="currentPage === 'items'">
                <div class="search-header">
                    <el-input v-model="searchKeyword" placeholder="搜索物品名称或固资号" style="width: 300px;">
                        <template #append>
                            <el-button @click="loadItems">搜索</el-button>
                        </template>
                    </el-input>
                    
                    <el-select v-model="filterLocation" placeholder="选择地点" @change="loadItems">
                        <el-option label="全部地点" value=""></el-option>
                        <el-option label="仓库A" value="仓库A"></el-option>
                        <el-option label="仓库B" value="仓库B"></el-option>
                        <el-option label="办公室" value="办公室"></el-option>
                    </el-select>
                </div>

                <el-table :data="items" v-loading="loading">
                    <el-table-column prop="asset_number" label="固资号" width="120"></el-table-column>
                    <el-table-column prop="item_name" label="物品名称"></el-table-column>
                    <el-table-column prop="location" label="存放地点" width="100"></el-table-column>
                    <el-table-column prop="total_quantity" label="总数量" width="80"></el-table-column>
                    <el-table-column prop="available_quantity" label="可用数量" width="80">
                        <template #default="scope">
                            <span :class="{ 'low-stock': scope.row.available_quantity === 0 }">
                                {{ scope.row.available_quantity }}
                            </span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="status" label="状态" width="100">
                        <template #default="scope">
                            <el-tag :type="getStatusType(scope.row.status)">
                                {{ getStatusText(scope.row.status) }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作" width="120">
                        <template #default="scope">
                            <el-button type="primary" size="small" 
                                      :disabled="scope.row.available_quantity === 0"
                                      @click="handleBorrow(scope.row)">
                                借用
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>

                <!-- 借用对话框 -->
                <el-dialog v-model="borrowDialogVisible" title="物品借用" width="500px">
                    <el-form :model="borrowForm" label-width="100px">
                        <el-form-item label="物品信息" v-if="selectedItem">
                            <div class="item-info">
                                <p><strong>固资号：</strong>{{ selectedItem.asset_number }}</p>
                                <p><strong>物品名称：</strong>{{ selectedItem.item_name }}</p>
                                <p><strong>可用数量：</strong>{{ selectedItem.available_quantity }}</p>
                            </div>
                        </el-form-item>
                        <el-form-item label="借用人姓名">
                            <el-input v-model="borrowForm.borrowerName" placeholder="请输入姓名"></el-input>
                        </el-form-item>
                        <el-form-item label="借用数量">
                            <el-input-number v-model="borrowForm.borrowQuantity" :min="1" :max="selectedItem ? selectedItem.available_quantity : 1"></el-input-number>
                            <span style="margin-left: 12px; color: #909399;">最大可借：{{ selectedItem ? selectedItem.available_quantity : 0 }}</span>
                        </el-form-item>
                    </el-form>
                    <template #footer>
                        <el-button @click="borrowDialogVisible = false">取消</el-button>
                        <el-button type="primary" @click="submitBorrow" :loading="borrowLoading">确认借用</el-button>
                    </template>
                </el-dialog>
            </div>

            <!-- 归还页面 -->
            <div v-if="currentPage === 'return'">
                <el-card>
                    <template #header>
                        <span>物品归还</span>
                    </template>
                    
                    <el-form :model="returnForm" label-width="100px">
                        <el-form-item label="固资号">
                            <el-input v-model="returnForm.assetNumber" placeholder="请输入固资号" style="width: 300px;"></el-input>
                        </el-form-item>
                        <el-form-item label="校验码">
                            <el-input v-model="returnForm.verificationCode" placeholder="请输入校验码" style="width: 300px;"></el-input>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" @click="searchBorrowRecord" :loading="searchLoading">查询借用记录</el-button>
                        </el-form-item>
                    </el-form>

                    <div v-if="borrowRecord" style="margin-top: 20px;">
                        <el-divider>借用记录信息</el-divider>
                        <el-descriptions :column="2" border>
                            <el-descriptions-item label="物品名称">{{ borrowRecord.item_name }}</el-descriptions-item>
                            <el-descriptions-item label="固资号">{{ borrowRecord.asset_number }}</el-descriptions-item>
                            <el-descriptions-item label="借用人">{{ borrowRecord.borrower_name }}</el-descriptions-item>
                            <el-descriptions-item label="借用数量">{{ borrowRecord.borrow_quantity }}</el-descriptions-item>
                            <el-descriptions-item label="借用时间">{{ formatDate(borrowRecord.borrow_time) }}</el-descriptions-item>
                        </el-descriptions>
                        <div style="text-align: center; margin-top: 20px;">
                            <el-button type="success" @click="confirmReturn" :loading="returnLoading">确认归还</el-button>
                        </div>
                    </div>
                </el-card>
            </div>

            <!-- 管理后台 -->
            <div v-if="currentPage === 'admin'">
                <el-card>
                    <template #header>
                        <span>物品批量导入</span>
                    </template>
                    
                    <el-alert title="导入格式说明" description="每行一个物品，格式：固资号,校验码,有效期(可选),物品名称(可选),存放地点(可选),数量(可选)" type="info" show-icon style="margin-bottom: 20px;"></el-alert>
                    
                    <el-input v-model="importData" type="textarea" :rows="10" placeholder="请输入导入数据，例如：&#10;GD2023001,123456,2024-12-31,笔记本电脑,仓库A,5&#10;GD2023002,654321,,投影仪,办公室,3"></el-input>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <el-button type="primary" @click="processImport" :loading="importLoading">执行导入</el-button>
                        <el-button @click="importData = ''">清空</el-button>
                    </div>
                </el-card>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage } = ElementPlus;
        
        const supabaseUrl = 'https://odbqlwjxlvhxdsgzkcki.supabase.co';  // 替换为你的 Supabase URL
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kYnFsd2p4bHZoeGRzZ3prY2tpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExOTA0ODQsImV4cCI6MjA3Njc2NjQ4NH0.oORfTnkprbe1ZhyBpyKYI84yGFmXkLtWU5Bbmuz1BsE';  // 替换为你的 Supabase anon key
        
        const app = createApp({
            setup() {
                const currentPage = Vue.ref('items');
                const activeMenu = Vue.ref('items');
                const items = Vue.ref([]);
                const loading = Vue.ref(false);
                const searchKeyword = Vue.ref('');
                const filterLocation = Vue.ref('');
                
                // 借用相关
                const borrowDialogVisible = Vue.ref(false);
                const selectedItem = Vue.ref(null);
                const borrowForm = Vue.ref({ borrowerName: '', borrowQuantity: 1 });
                const borrowLoading = Vue.ref(false);
                
                // 归还相关
                const returnForm = Vue.ref({ assetNumber: '', verificationCode: '' });
                const borrowRecord = Vue.ref(null);
                const searchLoading = Vue.ref(false);
                const returnLoading = Vue.ref(false);
                
                // 导入相关
                const importData = Vue.ref('');
                const importLoading = Vue.ref(false);
                
                // 创建 Supabase 客户端
                const supabase = supabase.createClient(supabaseUrl, supabaseKey);
                
                // 加载物品列表
                const loadItems = async () => {
                    loading.value = true;
                    try {
                        let query = supabase.from('items').select('*');
                        
                        if (searchKeyword.value) {
                            query = query.or(`item_name.ilike.%${searchKeyword.value}%,asset_number.ilike.%${searchKeyword.value}%`);
                        }
                        
                        if (filterLocation.value) {
                            query = query.eq('location', filterLocation.value);
                        }
                        
                        const { data, error } = await query.order('created_at', { ascending: false });
                        
                        if (error) throw error;
                        items.value = data;
                    } catch (error) {
                        ElMessage.error('加载物品列表失败: ' + error.message);
                    } finally {
                        loading.value = false;
                    }
                };
                
                // 打开借用对话框
                const handleBorrow = (item) => {
                    selectedItem.value = item;
                    borrowForm.value = {
                        borrowerName: '',
                        borrowQuantity: 1
                    };
                    borrowDialogVisible.value = true;
                };
                
                // 提交借用
                const submitBorrow = async () => {
                    if (!borrowForm.value.borrowerName) {
                        ElMessage.warning('请输入借用人姓名');
                        return;
                    }
                    
                    if (borrowForm.value.borrowQuantity > selectedItem.value.available_quantity) {
                        ElMessage.error('借用数量超过可用数量');
                        return;
                    }
                    
                    borrowLoading.value = true;
                    try {
                        // 更新物品数量
                        const { error: updateError } = await supabase
                            .from('items')
                            .update({ 
                                available_quantity: selectedItem.value.available_quantity - borrowForm.value.borrowQuantity 
                            })
                            .eq('id', selectedItem.value.id);
                        
                        if (updateError) throw updateError;
                        
                        // 创建借用记录
                        const { error } = await supabase
                            .from('borrow_records')
                            .insert({
                                item_id: selectedItem.value.id,
                                asset_number: selectedItem.value.asset_number,
                                borrower_name: borrowForm.value.borrowerName,
                                borrow_quantity: borrowForm.value.borrowQuantity
                            });
                        
                        if (error) throw error;
                        
                        ElMessage.success('借用成功');
                        borrowDialogVisible.value = false;
                        loadItems(); // 刷新列表
                    } catch (error) {
                        ElMessage.error('借用失败: ' + error.message);
                    } finally {
                        borrowLoading.value = false;
                    }
                };
                
                // 查询借用记录
                const searchBorrowRecord = async () => {
                    if (!returnForm.value.assetNumber || !returnForm.value.verificationCode) {
                        ElMessage.warning('请输入固资号和校验码');
                        return;
                    }
                    
                    searchLoading.value = true;
                    try {
                        const { data, error } = await supabase
                            .from('borrow_records')
                            .select(`
                                *,
                                items:item_id (
                                    item_name,
                                    verification_code
                                )
                            `)
                            .eq('asset_number', returnForm.value.assetNumber)
                            .eq('status', 'borrowed');
                        
                        if (error) throw error;
                        
                        const record = data.find(r => r.items.verification_code === returnForm.value.verificationCode);
                        if (!record) {
                            throw new Error('未找到有效的借用记录');
                        }
                        
                        borrowRecord.value = {
                            ...record,
                            item_name: record.items.item_name
                        };
                        
                        ElMessage.success('查询成功');
                    } catch (error) {
                        borrowRecord.value = null;
                        ElMessage.error(error.message);
                    } finally {
                        searchLoading.value = false;
                    }
                };
                
                // 确认归还
                const confirmReturn = async () => {
                    returnLoading.value = true;
                    try {
                        // 更新物品数量
                        const { error: updateError } = await supabase
                            .from('items')
                            .update({ 
                                available_quantity: supabase.sql`available_quantity + ${borrowRecord.value.borrow_quantity}`
                            })
                            .eq('id', borrowRecord.value.item_id);
                        
                        if (updateError) throw updateError;
                        
                        // 更新借用记录
                        const { error } = await supabase
                            .from('borrow_records')
                            .update({ 
                                status: 'returned',
                                actual_return_time: new Date().toISOString()
                            })
                            .eq('id', borrowRecord.value.id);
                        
                        if (error) throw error;
                        
                        ElMessage.success('归还成功');
                        borrowRecord.value = null;
                        returnForm.value = { assetNumber: '', verificationCode: '' };
                    } catch (error) {
                        ElMessage.error('归还失败: ' + error.message);
                    } finally {
                        returnLoading.value = false;
                    }
                };
                
                // 批量导入
                const processImport = async () => {
                    if (!importData.value.trim()) {
                        ElMessage.warning('请输入导入数据');
                        return;
                    }
                    
                    const lines = importData.value.split('\n').filter(line => line.trim());
                    const itemsToImport = [];
                    
                    for (let line of lines) {
                        const [assetNumber, verificationCode, expiryDate, itemName, location, quantity] = line.split(',');
                        
                        if (assetNumber && verificationCode) {
                            itemsToImport.push({
                                asset_number: assetNumber.trim(),
                                verification_code: verificationCode.trim(),
                                expiry_date: expiryDate ? expiryDate.trim() : null,
                                item_name: itemName ? itemName.trim() : '未命名物品',
                                location: location ? location.trim() : '默认地点',
                                total_quantity: parseInt(quantity) || 1,
                                available_quantity: parseInt(quantity) || 1
                            });
                        }
                    }
                    
                    if (itemsToImport.length === 0) {
                        ElMessage.warning('没有有效的物品数据');
                        return;
                    }
                    
                    importLoading.value = true;
                    try {
                        const { error } = await supabase
                            .from('items')
                            .insert(itemsToImport);
                        
                        if (error) throw error;
                        
                        ElMessage.success(`成功导入 ${itemsToImport.length} 个物品`);
                        importData.value = '';
                    } catch (error) {
                        ElMessage.error('导入失败: ' + error.message);
                    } finally {
                        importLoading.value = false;
                    }
                };
                
                // 工具函数
                const getStatusType = (status) => {
                    const types = { available: 'success', borrowed: 'warning', maintenance: 'danger' };
                    return types[status] || 'info';
                };
                
                const getStatusText = (status) => {
                    const texts = { available: '可用', borrowed: '已借用', maintenance: '维修中' };
                    return texts[status] || status;
                };
                
                const formatDate = (dateString) => {
                    return new Date(dateString).toLocaleString('zh-CN');
                };
                
                const handleMenuSelect = (index) => {
                    currentPage.value = index;
                    activeMenu.value = index;
                };
                
                // 初始化加载
                Vue.onMounted(() => {
                    loadItems();
                });
                
                return {
                    currentPage,
                    activeMenu,
                    items,
                    loading,
                    searchKeyword,
                    filterLocation,
                    borrowDialogVisible,
                    selectedItem,
                    borrowForm,
                    borrowLoading,
                    returnForm,
                    borrowRecord,
                    searchLoading,
                    returnLoading,
                    importData,
                    importLoading,
                    loadItems,
                    handleBorrow,
                    submitBorrow,
                    searchBorrowRecord,
                    confirmReturn,
                    processImport,
                    getStatusType,
                    getStatusText,
                    formatDate,
                    handleMenuSelect
                };
            }
        });
        
        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>
