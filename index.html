<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物品借用管理系统</title>
    <!-- 使用国内CDN -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/element-plus/2.3.8/index.min.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/element-plus/2.3.8/index.full.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.5.1/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #409EFF;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .nav {
            background: #f5f7fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e4e7ed;
        }
        .nav button {
            background: white;
            border: 1px solid #dcdfe6;
            padding: 8px 16px;
            margin-right: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .nav button.active {
            background: #409EFF;
            color: white;
            border-color: #409EFF;
        }
        .nav button:hover {
            background: #ecf5ff;
            border-color: #c6e2ff;
        }
        .content {
            padding: 20px;
            min-height: 400px;
        }
        .card {
            background: white;
            border: 1px solid #e4e7ed;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #606266;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #409EFF;
            outline: none;
        }
        .btn {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #66b1ff;
        }
        .btn-success {
            background: #67c23a;
        }
        .btn-success:hover {
            background: #85ce61;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .table th, .table td {
            border: 1px solid #e4e7ed;
            padding: 12px 8px;
            text-align: left;
        }
        .table th {
            background: #f5f7fa;
            font-weight: bold;
        }
        .table tr:hover {
            background: #f5f7fa;
        }
        .status-available { color: #67c23a; }
        .status-borrowed { color: #e6a23c; }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-box input {
            flex: 1;
        }
        .message {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .message.success {
            background: #f0f9ff;
            border: 1px solid #91d5ff;
            color: #096dd9;
        }
        .message.error {
            background: #fef0f0;
            border: 1px solid #fbc4c4;
            color: #d93030;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>📦 物品借用管理系统</h1>
            </div>
            
            <div class="nav">
                <button @click="currentPage = 'items'" :class="{ active: currentPage === 'items' }">物品列表</button>
                <button @click="currentPage = 'borrow'" :class="{ active: currentPage === 'borrow' }">借用物品</button>
                <button @click="currentPage = 'return'" :class="{ active: currentPage === 'return' }">归还物品</button>
                <button @click="currentPage = 'admin'" :class="{ active: currentPage === 'admin' }">数据管理</button>
            </div>

            <div class="content">
                <!-- 物品列表页面 -->
                <div v-if="currentPage === 'items'">
                    <div class="card">
                        <h2>物品列表</h2>
                        <div class="search-box">
                            <input type="text" v-model="searchKeyword" placeholder="搜索物品名称或固资号...">
                            <select v-model="filterLocation">
                                <option value="">全部地点</option>
                                <option value="仓库A">仓库A</option>
                                <option value="仓库B">仓库B</option>
                                <option value="办公室">办公室</option>
                            </select>
                            <button class="btn" @click="loadItems">搜索</button>
                        </div>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th>固资号</th>
                                    <th>物品名称</th>
                                    <th>存放地点</th>
                                    <th>总数量</th>
                                    <th>可用数量</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in filteredItems" :key="item.id">
                                    <td>{{ item.asset_number }}</td>
                                    <td>{{ item.item_name }}</td>
                                    <td>{{ item.location }}</td>
                                    <td>{{ item.total_quantity }}</td>
                                    <td :class="{ 'status-borrowed': item.available_quantity === 0 }">
                                        {{ item.available_quantity }}
                                    </td>
                                    <td>
                                        <span :class="getStatusClass(item.status)">{{ getStatusText(item.status) }}</span>
                                    </td>
                                    <td>
                                        <button class="btn" @click="borrowItem(item)" 
                                                :disabled="item.available_quantity === 0"
                                                style="padding: 5px 10px; font-size: 12px;">
                                            借用
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <div v-if="filteredItems.length === 0" style="text-align: center; padding: 40px; color: #909399;">
                            暂无物品数据
                        </div>
                    </div>
                </div>

                <!-- 借用页面 -->
                <div v-if="currentPage === 'borrow'">
                    <div class="card">
                        <h2>借用物品</h2>
                        <div class="form-group">
                            <label>选择物品</label>
                            <select v-model="selectedItemId">
                                <option value="">请选择物品</option>
                                <option v-for="item in availableItems" :value="item.id" :key="item.id">
                                    {{ item.item_name }} ({{ item.asset_number }}) - 可用: {{ item.available_quantity }}
                                </option>
                            </select>
                        </div>

                        <div v-if="selectedItem" class="form-group">
                            <label>物品信息</label>
                            <div style="background: #f5f7fa; padding: 15px; border-radius: 4px;">
                                <p><strong>固资号：</strong>{{ selectedItem.asset_number }}</p>
                                <p><strong>物品名称：</strong>{{ selectedItem.item_name }}</p>
                                <p><strong>存放地点：</strong>{{ selectedItem.location }}</p>
                                <p><strong>可用数量：</strong>{{ selectedItem.available_quantity }}</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>借用人姓名</label>
                            <input type="text" v-model="borrowForm.borrowerName" placeholder="请输入借用人姓名">
                        </div>

                        <div class="form-group">
                            <label>借用数量</label>
                            <input type="number" v-model="borrowForm.quantity" :max="selectedItem ? selectedItem.available_quantity : 1" min="1">
                        </div>

                        <button class="btn" @click="submitBorrow" :disabled="!canBorrow">确认借用</button>
                    </div>
                </div>

                <!-- 归还页面 -->
                <div v-if="currentPage === 'return'">
                    <div class="card">
                        <h2>归还物品</h2>
                        <div class="form-group">
                            <label>固资号</label>
                            <input type="text" v-model="returnForm.assetNumber" placeholder="请输入固资号">
                        </div>

                        <div class="form-group">
                            <label>校验码</label>
                            <input type="text" v-model="returnForm.verificationCode" placeholder="请输入校验码">
                        </div>

                        <button class="btn" @click="searchBorrowRecord">查询借用记录</button>

                        <div v-if="borrowRecord" style="margin-top: 20px;">
                            <h3>借用记录信息</h3>
                            <div style="background: #f0f9ff; padding: 15px; border-radius: 4px;">
                                <p><strong>物品名称：</strong>{{ borrowRecord.item_name }}</p>
                                <p><strong>固资号：</strong>{{ borrowRecord.asset_number }}</p>
                                <p><strong>借用人：</strong>{{ borrowRecord.borrower_name }}</p>
                                <p><strong>借用数量：</strong>{{ borrowRecord.borrow_quantity }}</p>
                                <p><strong>借用时间：</strong>{{ formatDate(borrowRecord.borrow_time) }}</p>
                            </div>
                            <button class="btn btn-success" @click="confirmReturn" style="margin-top: 15px;">确认归还</button>
                        </div>
                    </div>
                </div>

                <!-- 管理页面 -->
                <div v-if="currentPage === 'admin'">
                    <div class="card">
                        <h2>数据管理</h2>
                        
                        <div class="message success">
                            <strong>导入格式说明：</strong><br>
                            每行一个物品，格式：固资号,校验码,有效期(可选),物品名称,存放地点,数量
                        </div>

                        <div class="form-group">
                            <label>导入数据</label>
                            <textarea v-model="importData" rows="8" placeholder="请输入导入数据，例如：&#10;GD2023001,123456,2024-12-31,笔记本电脑,仓库A,5&#10;GD2023002,654321,,投影仪,办公室,3"></textarea>
                        </div>

                        <button class="btn" @click="importItems">导入数据</button>
                        <button class="btn btn-success" @click="addSampleData" style="margin-left: 10px;">添加示例数据</button>
                    </div>
                </div>

                <!-- 消息提示 -->
                <div v-if="message" :class="['message', message.type]">
                    {{ message.text }}
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        
        // 使用 localStorage 模拟数据库（国内可访问）
        const storage = {
            get(key) {
                try {
                    return JSON.parse(localStorage.getItem(key) || '[]');
                } catch {
                    return [];
                }
            },
            set(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            }
        };

        createApp({
            setup() {
                const currentPage = ref('items');
                const items = ref([]);
                const searchKeyword = ref('');
                const filterLocation = ref('');
                const message = ref(null);
                
                // 借用相关
                const selectedItemId = ref('');
                const borrowForm = ref({
                    borrowerName: '',
                    quantity: 1
                });
                
                // 归还相关
                const returnForm = ref({
                    assetNumber: '',
                    verificationCode: ''
                });
                const borrowRecord = ref(null);
                const borrowRecords = ref([]);

                // 初始化数据
                const initializeData = () => {
                    if (storage.get('items').length === 0) {
                        // 添加示例数据
                        const sampleItems = [
                            {
                                id: 1,
                                asset_number: 'GD2023001',
                                verification_code: '123456',
                                item_name: '笔记本电脑',
                                location: '仓库A',
                                total_quantity: 5,
                                available_quantity: 5,
                                status: 'available'
                            },
                            {
                                id: 2,
                                asset_number: 'GD2023002',
                                verification_code: '654321',
                                item_name: '投影仪',
                                location: '办公室',
                                total_quantity: 3,
                                available_quantity: 3,
                                status: 'available'
                            }
                        ];
                        storage.set('items', sampleItems);
                    }
                    
                    items.value = storage.get('items');
                    borrowRecords.value = storage.get('borrow_records');
                };

                // 显示消息
                const showMessage = (text, type = 'success') => {
                    message.value = { text, type };
                    setTimeout(() => {
                        message.value = null;
                    }, 3000);
                };

                // 计算属性
                const filteredItems = computed(() => {
                    return items.value.filter(item => {
                        const matchesSearch = !searchKeyword.value || 
                            item.item_name.includes(searchKeyword.value) || 
                            item.asset_number.includes(searchKeyword.value);
                        const matchesLocation = !filterLocation.value || 
                            item.location === filterLocation.value;
                        return matchesSearch && matchesLocation;
                    });
                });

                const availableItems = computed(() => {
                    return items.value.filter(item => item.available_quantity > 0);
                });

                const selectedItem = computed(() => {
                    return items.value.find(item => item.id == selectedItemId.value);
                });

                const canBorrow = computed(() => {
                    return selectedItem.value && 
                           borrowForm.value.borrowerName && 
                           borrowForm.value.quantity > 0 &&
                           borrowForm.value.quantity <= selectedItem.value.available_quantity;
                });

                // 方法
                const loadItems = () => {
                    items.value = storage.get('items');
                };

                const borrowItem = (item) => {
                    selectedItemId.value = item.id;
                    borrowForm.value.quantity = 1;
                    currentPage.value = 'borrow';
                };

                const submitBorrow = () => {
                    if (!canBorrow.value) {
                        showMessage('请填写完整的借用信息', 'error');
                        return;
                    }

                    const item = selectedItem.value;
                    const borrowRecord = {
                        id: Date.now(),
                        item_id: item.id,
                        asset_number: item.asset_number,
                        borrower_name: borrowForm.value.borrowerName,
                        borrow_quantity: borrowForm.value.quantity,
                        borrow_time: new Date().toISOString(),
                        status: 'borrowed'
                    };

                    // 更新物品数量
                    item.available_quantity -= borrowForm.value.quantity;
                    if (item.available_quantity === 0) {
                        item.status = 'borrowed';
                    }

                    // 保存记录
                    const records = storage.get('borrow_records');
                    records.push(borrowRecord);
                    storage.set('borrow_records', records);

                    // 更新物品数据
                    storage.set('items', items.value);

                    showMessage('借用成功！');
                    resetBorrowForm();
                    currentPage.value = 'items';
                    loadItems();
                };

                const searchBorrowRecord = () => {
                    const records = storage.get('borrow_records');
                    const record = records.find(r => 
                        r.asset_number === returnForm.value.assetNumber && 
                        r.status === 'borrowed'
                    );

                    if (record) {
                        const item = items.value.find(i => i.id === record.item_id);
                        if (item && item.verification_code === returnForm.value.verificationCode) {
                            borrowRecord.value = {
                                ...record,
                                item_name: item.item_name
                            };
                            showMessage('找到借用记录');
                        } else {
                            showMessage('校验码错误', 'error');
                        }
                    } else {
                        showMessage('未找到借用记录', 'error');
                    }
                };

                const confirmReturn = () => {
                    const record = borrowRecord.value;
                    const item = items.value.find(i => i.id === record.item_id);
                    
                    if (item) {
                        // 恢复物品数量
                        item.available_quantity += record.borrow_quantity;
                        item.status = 'available';

                        // 更新借用记录
                        const records = storage.get('borrow_records');
                        const recordIndex = records.findIndex(r => r.id === record.id);
                        if (recordIndex > -1) {
                            records[recordIndex].status = 'returned';
                            records[recordIndex].return_time = new Date().toISOString();
                            storage.set('borrow_records', records);
                        }

                        // 更新物品数据
                        storage.set('items', items.value);

                        showMessage('归还成功！');
                        resetReturnForm();
                        loadItems();
                    }
                };

                const importItems = () => {
                    if (!importData.value.trim()) {
                        showMessage('请输入导入数据', 'error');
                        return;
                    }

                    const lines = importData.value.split('\n').filter(line => line.trim());
                    const newItems = [];
                    let nextId = Math.max(...items.value.map(i => i.id), 0) + 1;

                    for (let line of lines) {
                        const [assetNumber, verificationCode, expiryDate, itemName, location, quantity] = line.split(',');
                        
                        if (assetNumber && verificationCode) {
                            newItems.push({
                                id: nextId++,
                                asset_number: assetNumber.trim(),
                                verification_code: verificationCode.trim(),
                                expiry_date: expiryDate ? expiryDate.trim() : null,
                                item_name: itemName ? itemName.trim() : '未命名物品',
                                location: location ? location.trim() : '默认地点',
                                total_quantity: parseInt(quantity) || 1,
                                available_quantity: parseInt(quantity) || 1,
                                status: 'available'
                            });
                        }
                    }

                    if (newItems.length === 0) {
                        showMessage('没有有效的物品数据', 'error');
                        return;
                    }

                    const allItems = [...items.value, ...newItems];
                    storage.set('items', allItems);
                    items.value = allItems;
                    
                    showMessage(`成功导入 ${newItems.length} 个物品`);
                    importData.value = '';
                };

                const addSampleData = () => {
                    importData.value = `GD2023001,123456,2024-12-31,笔记本电脑,仓库A,5
GD2023002,654321,2024-06-30,投影仪,办公室,3
GD2023003,112233,,办公椅,仓库B,10
GD2023004,445566,,打印机,仓库A,2`;
                    showMessage('已填充示例数据，点击"导入数据"按钮导入');
                };

                // 工具函数
                const getStatusClass = (status) => {
                    const classes = {
                        available: 'status-available',
                        borrowed: 'status-borrowed'
                    };
                    return classes[status] || '';
                };

                const getStatusText = (status) => {
                    const texts = {
                        available: '可用',
                        borrowed: '已借用'
                    };
                    return texts[status] || status;
                };

                const formatDate = (dateString) => {
                    return new Date(dateString).toLocaleString('zh-CN');
                };

                const resetBorrowForm = () => {
                    selectedItemId.value = '';
                    borrowForm.value = {
                        borrowerName: '',
                        quantity: 1
                    };
                };

                const resetReturnForm = () => {
                    returnForm.value = {
                        assetNumber: '',
                        verificationCode: ''
                    };
                    borrowRecord.value = null;
                };

                // 初始化
                onMounted(() => {
                    initializeData();
                });

                return {
                    currentPage,
                    items,
                    searchKeyword,
                    filterLocation,
                    message,
                    selectedItemId,
                    borrowForm,
                    returnForm,
                    borrowRecord,
                    importData: ref(''),
                    filteredItems,
                    availableItems,
                    selectedItem,
                    canBorrow,
                    loadItems,
                    borrowItem,
                    submitBorrow,
                    searchBorrowRecord,
                    confirmReturn,
                    importItems,
                    addSampleData,
                    getStatusClass,
                    getStatusText,
                    formatDate
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
