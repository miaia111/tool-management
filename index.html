<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©å“å€Ÿç”¨ç®¡ç†ç³»ç»Ÿ</title>
    <!-- ä½¿ç”¨å›½å†…CDN -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/element-plus/2.3.8/index.min.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/element-plus/2.3.8/index.full.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.5.1/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #409EFF;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .nav {
            background: #f5f7fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e4e7ed;
        }
        .nav button {
            background: white;
            border: 1px solid #dcdfe6;
            padding: 8px 16px;
            margin-right: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .nav button.active {
            background: #409EFF;
            color: white;
            border-color: #409EFF;
        }
        .nav button:hover {
            background: #ecf5ff;
            border-color: #c6e2ff;
        }
        .content {
            padding: 20px;
            min-height: 400px;
        }
        .card {
            background: white;
            border: 1px solid #e4e7ed;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #606266;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #409EFF;
            outline: none;
        }
        .btn {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #66b1ff;
        }
        .btn-success {
            background: #67c23a;
        }
        .btn-success:hover {
            background: #85ce61;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .table th, .table td {
            border: 1px solid #e4e7ed;
            padding: 12px 8px;
            text-align: left;
        }
        .table th {
            background: #f5f7fa;
            font-weight: bold;
        }
        .table tr:hover {
            background: #f5f7fa;
        }
        .status-available { color: #67c23a; }
        .status-borrowed { color: #e6a23c; }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-box input {
            flex: 1;
        }
        .message {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .message.success {
            background: #f0f9ff;
            border: 1px solid #91d5ff;
            color: #096dd9;
        }
        .message.error {
            background: #fef0f0;
            border: 1px solid #fbc4c4;
            color: #d93030;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>ğŸ“¦ ç‰©å“å€Ÿç”¨ç®¡ç†ç³»ç»Ÿ</h1>
            </div>
            
            <div class="nav">
                <button @click="currentPage = 'items'" :class="{ active: currentPage === 'items' }">ç‰©å“åˆ—è¡¨</button>
                <button @click="currentPage = 'borrow'" :class="{ active: currentPage === 'borrow' }">å€Ÿç”¨ç‰©å“</button>
                <button @click="currentPage = 'return'" :class="{ active: currentPage === 'return' }">å½’è¿˜ç‰©å“</button>
                <button @click="currentPage = 'admin'" :class="{ active: currentPage === 'admin' }">æ•°æ®ç®¡ç†</button>
            </div>

            <div class="content">
                <!-- ç‰©å“åˆ—è¡¨é¡µé¢ -->
                <div v-if="currentPage === 'items'">
                    <div class="card">
                        <h2>ç‰©å“åˆ—è¡¨</h2>
                        <div class="search-box">
                            <input type="text" v-model="searchKeyword" placeholder="æœç´¢ç‰©å“åç§°æˆ–å›ºèµ„å·...">
                            <select v-model="filterLocation">
                                <option value="">å…¨éƒ¨åœ°ç‚¹</option>
                                <option value="ä»“åº“A">ä»“åº“A</option>
                                <option value="ä»“åº“B">ä»“åº“B</option>
                                <option value="åŠå…¬å®¤">åŠå…¬å®¤</option>
                            </select>
                            <button class="btn" @click="loadItems">æœç´¢</button>
                        </div>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th>å›ºèµ„å·</th>
                                    <th>ç‰©å“åç§°</th>
                                    <th>å­˜æ”¾åœ°ç‚¹</th>
                                    <th>æ€»æ•°é‡</th>
                                    <th>å¯ç”¨æ•°é‡</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in filteredItems" :key="item.id">
                                    <td>{{ item.asset_number }}</td>
                                    <td>{{ item.item_name }}</td>
                                    <td>{{ item.location }}</td>
                                    <td>{{ item.total_quantity }}</td>
                                    <td :class="{ 'status-borrowed': item.available_quantity === 0 }">
                                        {{ item.available_quantity }}
                                    </td>
                                    <td>
                                        <span :class="getStatusClass(item.status)">{{ getStatusText(item.status) }}</span>
                                    </td>
                                    <td>
                                        <button class="btn" @click="borrowItem(item)" 
                                                :disabled="item.available_quantity === 0"
                                                style="padding: 5px 10px; font-size: 12px;">
                                            å€Ÿç”¨
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <div v-if="filteredItems.length === 0" style="text-align: center; padding: 40px; color: #909399;">
                            æš‚æ— ç‰©å“æ•°æ®
                        </div>
                    </div>
                </div>

                <!-- å€Ÿç”¨é¡µé¢ -->
                <div v-if="currentPage === 'borrow'">
                    <div class="card">
                        <h2>å€Ÿç”¨ç‰©å“</h2>
                        <div class="form-group">
                            <label>é€‰æ‹©ç‰©å“</label>
                            <select v-model="selectedItemId">
                                <option value="">è¯·é€‰æ‹©ç‰©å“</option>
                                <option v-for="item in availableItems" :value="item.id" :key="item.id">
                                    {{ item.item_name }} ({{ item.asset_number }}) - å¯ç”¨: {{ item.available_quantity }}
                                </option>
                            </select>
                        </div>

                        <div v-if="selectedItem" class="form-group">
                            <label>ç‰©å“ä¿¡æ¯</label>
                            <div style="background: #f5f7fa; padding: 15px; border-radius: 4px;">
                                <p><strong>å›ºèµ„å·ï¼š</strong>{{ selectedItem.asset_number }}</p>
                                <p><strong>ç‰©å“åç§°ï¼š</strong>{{ selectedItem.item_name }}</p>
                                <p><strong>å­˜æ”¾åœ°ç‚¹ï¼š</strong>{{ selectedItem.location }}</p>
                                <p><strong>å¯ç”¨æ•°é‡ï¼š</strong>{{ selectedItem.available_quantity }}</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>å€Ÿç”¨äººå§“å</label>
                            <input type="text" v-model="borrowForm.borrowerName" placeholder="è¯·è¾“å…¥å€Ÿç”¨äººå§“å">
                        </div>

                        <div class="form-group">
                            <label>å€Ÿç”¨æ•°é‡</label>
                            <input type="number" v-model="borrowForm.quantity" :max="selectedItem ? selectedItem.available_quantity : 1" min="1">
                        </div>

                        <button class="btn" @click="submitBorrow" :disabled="!canBorrow">ç¡®è®¤å€Ÿç”¨</button>
                    </div>
                </div>

                <!-- å½’è¿˜é¡µé¢ -->
                <div v-if="currentPage === 'return'">
                    <div class="card">
                        <h2>å½’è¿˜ç‰©å“</h2>
                        <div class="form-group">
                            <label>å›ºèµ„å·</label>
                            <input type="text" v-model="returnForm.assetNumber" placeholder="è¯·è¾“å…¥å›ºèµ„å·">
                        </div>

                        <div class="form-group">
                            <label>æ ¡éªŒç </label>
                            <input type="text" v-model="returnForm.verificationCode" placeholder="è¯·è¾“å…¥æ ¡éªŒç ">
                        </div>

                        <button class="btn" @click="searchBorrowRecord">æŸ¥è¯¢å€Ÿç”¨è®°å½•</button>

                        <div v-if="borrowRecord" style="margin-top: 20px;">
                            <h3>å€Ÿç”¨è®°å½•ä¿¡æ¯</h3>
                            <div style="background: #f0f9ff; padding: 15px; border-radius: 4px;">
                                <p><strong>ç‰©å“åç§°ï¼š</strong>{{ borrowRecord.item_name }}</p>
                                <p><strong>å›ºèµ„å·ï¼š</strong>{{ borrowRecord.asset_number }}</p>
                                <p><strong>å€Ÿç”¨äººï¼š</strong>{{ borrowRecord.borrower_name }}</p>
                                <p><strong>å€Ÿç”¨æ•°é‡ï¼š</strong>{{ borrowRecord.borrow_quantity }}</p>
                                <p><strong>å€Ÿç”¨æ—¶é—´ï¼š</strong>{{ formatDate(borrowRecord.borrow_time) }}</p>
                            </div>
                            <button class="btn btn-success" @click="confirmReturn" style="margin-top: 15px;">ç¡®è®¤å½’è¿˜</button>
                        </div>
                    </div>
                </div>

                <!-- ç®¡ç†é¡µé¢ -->
                <div v-if="currentPage === 'admin'">
                    <div class="card">
                        <h2>æ•°æ®ç®¡ç†</h2>
                        
                        <div class="message success">
                            <strong>å¯¼å…¥æ ¼å¼è¯´æ˜ï¼š</strong><br>
                            æ¯è¡Œä¸€ä¸ªç‰©å“ï¼Œæ ¼å¼ï¼šå›ºèµ„å·,æ ¡éªŒç ,æœ‰æ•ˆæœŸ(å¯é€‰),ç‰©å“åç§°,å­˜æ”¾åœ°ç‚¹,æ•°é‡
                        </div>

                        <div class="form-group">
                            <label>å¯¼å…¥æ•°æ®</label>
                            <textarea v-model="importData" rows="8" placeholder="è¯·è¾“å…¥å¯¼å…¥æ•°æ®ï¼Œä¾‹å¦‚ï¼š&#10;GD2023001,123456,2024-12-31,ç¬”è®°æœ¬ç”µè„‘,ä»“åº“A,5&#10;GD2023002,654321,,æŠ•å½±ä»ª,åŠå…¬å®¤,3"></textarea>
                        </div>

                        <button class="btn" @click="importItems">å¯¼å…¥æ•°æ®</button>
                        <button class="btn btn-success" @click="addSampleData" style="margin-left: 10px;">æ·»åŠ ç¤ºä¾‹æ•°æ®</button>
                    </div>
                </div>

                <!-- æ¶ˆæ¯æç¤º -->
                <div v-if="message" :class="['message', message.type]">
                    {{ message.text }}
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        
        // ä½¿ç”¨ localStorage æ¨¡æ‹Ÿæ•°æ®åº“ï¼ˆå›½å†…å¯è®¿é—®ï¼‰
        const storage = {
            get(key) {
                try {
                    return JSON.parse(localStorage.getItem(key) || '[]');
                } catch {
                    return [];
                }
            },
            set(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            }
        };

        createApp({
            setup() {
                const currentPage = ref('items');
                const items = ref([]);
                const searchKeyword = ref('');
                const filterLocation = ref('');
                const message = ref(null);
                
                // å€Ÿç”¨ç›¸å…³
                const selectedItemId = ref('');
                const borrowForm = ref({
                    borrowerName: '',
                    quantity: 1
                });
                
                // å½’è¿˜ç›¸å…³
                const returnForm = ref({
                    assetNumber: '',
                    verificationCode: ''
                });
                const borrowRecord = ref(null);
                const borrowRecords = ref([]);

                // åˆå§‹åŒ–æ•°æ®
                const initializeData = () => {
                    if (storage.get('items').length === 0) {
                        // æ·»åŠ ç¤ºä¾‹æ•°æ®
                        const sampleItems = [
                            {
                                id: 1,
                                asset_number: 'GD2023001',
                                verification_code: '123456',
                                item_name: 'ç¬”è®°æœ¬ç”µè„‘',
                                location: 'ä»“åº“A',
                                total_quantity: 5,
                                available_quantity: 5,
                                status: 'available'
                            },
                            {
                                id: 2,
                                asset_number: 'GD2023002',
                                verification_code: '654321',
                                item_name: 'æŠ•å½±ä»ª',
                                location: 'åŠå…¬å®¤',
                                total_quantity: 3,
                                available_quantity: 3,
                                status: 'available'
                            }
                        ];
                        storage.set('items', sampleItems);
                    }
                    
                    items.value = storage.get('items');
                    borrowRecords.value = storage.get('borrow_records');
                };

                // æ˜¾ç¤ºæ¶ˆæ¯
                const showMessage = (text, type = 'success') => {
                    message.value = { text, type };
                    setTimeout(() => {
                        message.value = null;
                    }, 3000);
                };

                // è®¡ç®—å±æ€§
                const filteredItems = computed(() => {
                    return items.value.filter(item => {
                        const matchesSearch = !searchKeyword.value || 
                            item.item_name.includes(searchKeyword.value) || 
                            item.asset_number.includes(searchKeyword.value);
                        const matchesLocation = !filterLocation.value || 
                            item.location === filterLocation.value;
                        return matchesSearch && matchesLocation;
                    });
                });

                const availableItems = computed(() => {
                    return items.value.filter(item => item.available_quantity > 0);
                });

                const selectedItem = computed(() => {
                    return items.value.find(item => item.id == selectedItemId.value);
                });

                const canBorrow = computed(() => {
                    return selectedItem.value && 
                           borrowForm.value.borrowerName && 
                           borrowForm.value.quantity > 0 &&
                           borrowForm.value.quantity <= selectedItem.value.available_quantity;
                });

                // æ–¹æ³•
                const loadItems = () => {
                    items.value = storage.get('items');
                };

                const borrowItem = (item) => {
                    selectedItemId.value = item.id;
                    borrowForm.value.quantity = 1;
                    currentPage.value = 'borrow';
                };

                const submitBorrow = () => {
                    if (!canBorrow.value) {
                        showMessage('è¯·å¡«å†™å®Œæ•´çš„å€Ÿç”¨ä¿¡æ¯', 'error');
                        return;
                    }

                    const item = selectedItem.value;
                    const borrowRecord = {
                        id: Date.now(),
                        item_id: item.id,
                        asset_number: item.asset_number,
                        borrower_name: borrowForm.value.borrowerName,
                        borrow_quantity: borrowForm.value.quantity,
                        borrow_time: new Date().toISOString(),
                        status: 'borrowed'
                    };

                    // æ›´æ–°ç‰©å“æ•°é‡
                    item.available_quantity -= borrowForm.value.quantity;
                    if (item.available_quantity === 0) {
                        item.status = 'borrowed';
                    }

                    // ä¿å­˜è®°å½•
                    const records = storage.get('borrow_records');
                    records.push(borrowRecord);
                    storage.set('borrow_records', records);

                    // æ›´æ–°ç‰©å“æ•°æ®
                    storage.set('items', items.value);

                    showMessage('å€Ÿç”¨æˆåŠŸï¼');
                    resetBorrowForm();
                    currentPage.value = 'items';
                    loadItems();
                };

                const searchBorrowRecord = () => {
                    const records = storage.get('borrow_records');
                    const record = records.find(r => 
                        r.asset_number === returnForm.value.assetNumber && 
                        r.status === 'borrowed'
                    );

                    if (record) {
                        const item = items.value.find(i => i.id === record.item_id);
                        if (item && item.verification_code === returnForm.value.verificationCode) {
                            borrowRecord.value = {
                                ...record,
                                item_name: item.item_name
                            };
                            showMessage('æ‰¾åˆ°å€Ÿç”¨è®°å½•');
                        } else {
                            showMessage('æ ¡éªŒç é”™è¯¯', 'error');
                        }
                    } else {
                        showMessage('æœªæ‰¾åˆ°å€Ÿç”¨è®°å½•', 'error');
                    }
                };

                const confirmReturn = () => {
                    const record = borrowRecord.value;
                    const item = items.value.find(i => i.id === record.item_id);
                    
                    if (item) {
                        // æ¢å¤ç‰©å“æ•°é‡
                        item.available_quantity += record.borrow_quantity;
                        item.status = 'available';

                        // æ›´æ–°å€Ÿç”¨è®°å½•
                        const records = storage.get('borrow_records');
                        const recordIndex = records.findIndex(r => r.id === record.id);
                        if (recordIndex > -1) {
                            records[recordIndex].status = 'returned';
                            records[recordIndex].return_time = new Date().toISOString();
                            storage.set('borrow_records', records);
                        }

                        // æ›´æ–°ç‰©å“æ•°æ®
                        storage.set('items', items.value);

                        showMessage('å½’è¿˜æˆåŠŸï¼');
                        resetReturnForm();
                        loadItems();
                    }
                };

                const importItems = () => {
                    if (!importData.value.trim()) {
                        showMessage('è¯·è¾“å…¥å¯¼å…¥æ•°æ®', 'error');
                        return;
                    }

                    const lines = importData.value.split('\n').filter(line => line.trim());
                    const newItems = [];
                    let nextId = Math.max(...items.value.map(i => i.id), 0) + 1;

                    for (let line of lines) {
                        const [assetNumber, verificationCode, expiryDate, itemName, location, quantity] = line.split(',');
                        
                        if (assetNumber && verificationCode) {
                            newItems.push({
                                id: nextId++,
                                asset_number: assetNumber.trim(),
                                verification_code: verificationCode.trim(),
                                expiry_date: expiryDate ? expiryDate.trim() : null,
                                item_name: itemName ? itemName.trim() : 'æœªå‘½åç‰©å“',
                                location: location ? location.trim() : 'é»˜è®¤åœ°ç‚¹',
                                total_quantity: parseInt(quantity) || 1,
                                available_quantity: parseInt(quantity) || 1,
                                status: 'available'
                            });
                        }
                    }

                    if (newItems.length === 0) {
                        showMessage('æ²¡æœ‰æœ‰æ•ˆçš„ç‰©å“æ•°æ®', 'error');
                        return;
                    }

                    const allItems = [...items.value, ...newItems];
                    storage.set('items', allItems);
                    items.value = allItems;
                    
                    showMessage(`æˆåŠŸå¯¼å…¥ ${newItems.length} ä¸ªç‰©å“`);
                    importData.value = '';
                };

                const addSampleData = () => {
                    importData.value = `GD2023001,123456,2024-12-31,ç¬”è®°æœ¬ç”µè„‘,ä»“åº“A,5
GD2023002,654321,2024-06-30,æŠ•å½±ä»ª,åŠå…¬å®¤,3
GD2023003,112233,,åŠå…¬æ¤…,ä»“åº“B,10
GD2023004,445566,,æ‰“å°æœº,ä»“åº“A,2`;
                    showMessage('å·²å¡«å……ç¤ºä¾‹æ•°æ®ï¼Œç‚¹å‡»"å¯¼å…¥æ•°æ®"æŒ‰é’®å¯¼å…¥');
                };

                // å·¥å…·å‡½æ•°
                const getStatusClass = (status) => {
                    const classes = {
                        available: 'status-available',
                        borrowed: 'status-borrowed'
                    };
                    return classes[status] || '';
                };

                const getStatusText = (status) => {
                    const texts = {
                        available: 'å¯ç”¨',
                        borrowed: 'å·²å€Ÿç”¨'
                    };
                    return texts[status] || status;
                };

                const formatDate = (dateString) => {
                    return new Date(dateString).toLocaleString('zh-CN');
                };

                const resetBorrowForm = () => {
                    selectedItemId.value = '';
                    borrowForm.value = {
                        borrowerName: '',
                        quantity: 1
                    };
                };

                const resetReturnForm = () => {
                    returnForm.value = {
                        assetNumber: '',
                        verificationCode: ''
                    };
                    borrowRecord.value = null;
                };

                // åˆå§‹åŒ–
                onMounted(() => {
                    initializeData();
                });

                return {
                    currentPage,
                    items,
                    searchKeyword,
                    filterLocation,
                    message,
                    selectedItemId,
                    borrowForm,
                    returnForm,
                    borrowRecord,
                    importData: ref(''),
                    filteredItems,
                    availableItems,
                    selectedItem,
                    canBorrow,
                    loadItems,
                    borrowItem,
                    submitBorrow,
                    searchBorrowRecord,
                    confirmReturn,
                    importItems,
                    addSampleData,
                    getStatusClass,
                    getStatusText,
                    formatDate
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
